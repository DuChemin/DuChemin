<!--  RF MAY 2014:  This file INCLUDES changes from Portier Branch.  AH:  Please review logic for My Work/My Favorites/ My Discussions -->
{% extends "base.html" %}
{% load notetext %}

{% block header %}
  <script src="/static/js/notes.js"></script>
  <script src="/static/js/notation.js"></script>
  <script src="/static/js/favourites.js"></script>
  <!-- 
  <script type="text/javascript" src="http://vm-duchemin.haverford.edu:8080/assets/scripts/libs/vexflow-free.js"></script>
  <script type="text/javascript" src="http://vm-duchemin.haverford.edu:8080/assets/scripts/libs/meitovexflow.js"></script>
  -->
  <script type="text/javascript">
    $(document).ready(function (){
        attachFavouritesAction();
        submitNoteAction();
        editNoteAction();
    });
  </script>

  <script type="text/JavaScript" src="/static/js/bootstrap/bootstrap.min.js"></script>

  <!--
    JAVASCRIPT FOR MEIVIEW NECESSARY
    (CANVAS ON CLICKED OBSERVATION)
  -->
{% endblock %}

{% block wrap %}
  <div class="row-fluid">
    <div class="span9"><!-- Everything on the left -->
      <div class="row-fluid">
        <hgroup class="account-title page-title span8">
          <h1>Account Profile</h1>
          <h2>{{ user.profile }}</h2>
        </hgroup>
        <form class="mywork-search pull-right" method="get" action="/search">
          <input type="text" name="q" placeholder="Search My Work" />
        </form>
      </div>
      <div class="row-fluid">
        <div class="span12 favorites-container content-container">
          <div class="tabbable tabs-left">
            <ul class="nav nav-tabs">
              <li class="active"><a href="#tab1" data-toggle="tab">My Work</a></li>
              <li><a href="#tab2" data-toggle="tab">Favourites</a></li>
              <li><a href="#tab3" data-toggle="tab">Discussions</a></li>
            </ul>

            <div class="tab-content">
              <!-- Everything in tabs is here. -->
              <div class="tab-pane active" id="tab1">
                <!-- My Work: Observations and Reconstructions -->
                <div class="accordion-group">
                  <!-- My Observations -->
                  <div class="accordion-heading">
                    <a class="accordion-toggle" data-toggle="collapse" href="#mypieces-section">
                      <h2>Observations<i class="icon-plus"></i></h2>
                    </a>
                  </div>
                  <div id="mypieces-section" class="accordion-body collapse">
                    <div class="accordion-inner">
                      <table class="table table-striped table-bordered table-hover">
                        <thead>
                          <tr>
                            <th>Piece&nbsp;ID</th>
                            <th>Title</th>
                            <th>Measures</th>
                            <th>Show details</th>
                          </tr>
                        </thead>

                        <tbody>
                          {% for analysis in my_analyses %}
                            <tr>
                              <td>
                                <a href="/piece/{{ analysis.composition_number.piece_id }}">{{ analysis.composition_number.piece_id }}</a>
                              </td>
                              <td>
                                {{ analysis.composition_number.title }}
                              </td>
                              <td>
                                <a href="#" class="view-analysis" anid="{{ analysis.id }}">{{ analysis.start_measure }}&ndash;{{ analysis.stop_measure }}</a>
                              </td>
                              <td> 
                                <a href="#" class="analyses-info-expand" target="analyses-info-{{ forloop.counter }}">Expand</a>
                              </td>
                            </tr>
                            <tr id="analyses-info-{{ forloop.counter }}" class="analyses-info">
                              <td colspan="5">
                                {% include "analysis/analysis_extended_display_info.html" %}
                              </td>
                            </tr>
                          {% empty %}
                            <td colspan="4">No observations made.</td>
                          {% endfor %}
                        </tbody>
                      </table> 
                    </div>
                  </div>
                </div>
                
                <div class="spacerTop">
                </div>
                
                <div class="accordion-group">
                  <!-- My Reconstructions -->
                  <div class="accordion-heading">
                    <a class="accordion-toggle" data-toggle="collapse" href="#myreconstructions-section">
                      <h2>Reconstructions<i class="icon-plus"></i></h2>
                    </a>
                  </div>
                  <div id="myreconstructions-section" class="accordion-body collapse">
                    <div class="accordion-inner">
                      <table id="reconstructions" class="table table-striped table-bordered table-hover">
                        <thead>
                          <tr>
                            <th>Piece&nbsp;ID</th>
                            <th>Title</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for recon in my_reconstructions %}
                            <tr>
                                <td><a href="/piece/{{ recon.piece.piece_id }}">{{ recon.piece.piece_id }}</a></td>
                                <td>{{ recon.piece.title }}</td>
                            </tr>
                          {% empty %}
                            <td colspan="2">No reconstructions made.</td>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>

              <div class="tab-pane" id="tab2">
                <!-- My Favourites: Pieces and Reconstructions -->
                <div class="accordion-group">
                  <!-- Favourite Pieces -->
                  <div class="accordion-heading">
                    <a class="accordion-toggle" data-toggle="collapse" href="#favpieces-section">
                      <h2>Pieces<i class="icon-minus"></i></h2>
                    </a>
                  </div>
                  <div id="favpieces-section" class="accordion-body in collapse">
                    <div class="accordion-inner">
                      <table class="table table-striped table-bordered table-hover">
                        <thead>
                          <tr>
                            <th>Piece&nbsp;ID</th>
                            <th>Title</th>
                            <th>Notes</th>
                            <th>Favourites</th>
                          </tr>
                        </thead>
                        <tbody>
                          <form id="modal-form">
                          	{% csrf_token %}
                          </form>
                          {% for piece in favourited_pieces %}
                            <tr>
                              <td><a href="/piece/{{ piece.piece_id }}">{{ piece.piece_id }}</a></td>
                              <td>{{ piece.title }}</td>
                              <td style="text-align:center;">
                                {% if user|notetext:piece %}
                                  <a href="#" id="button-{{ piece.piece_id }}" class="btn btn-info open-EditNote" data-toggle="modal" data-notetext="{{ user|notetext:piece }}" data-pieceid="{{ piece.piece_id }}" title="Edit Note to {{ piece.piece_id }}">Edit Note</a>
                                {% else %}
                                  <a href="#" id="button-{{ piece.piece_id }}" class="btn btn-primary open-EditNote" data-toggle="modal" data-edittype="add" data-pieceid="{{ piece.piece_id }}" title="Add Note to {{ piece.piece_id }}">Add Note</a>
                                {% endif %}
                              </td>
                              <td>
                                  {% include "main/favourites/favourites.html" with is_favourite=True piece_id=piece.piece_id %}
                              </td>
                            </tr>
                          {% empty %}
                            <td colspan="4">No pieces in Favourites.</td>
                          {% endfor %}
                        </tbody>
                      </table> 
                    </div>
                  </div>
                </div>
              
                <!-- Favourite reconstructions
                (Currently deemed unnecessary)
                <div class="spacerTop">
                </div>

                <div class="accordion-group">

                  <div class="accordion-heading">
                    <a class="accordion-toggle" id="sidebar-accordion" data-toggle="collapse" href="#favreconstructions-section">
                      <h2>Reconstructions<i class="icon-plus" id="toggle"></i></h2>
                    </a>
                  </div>
                  <div id="favreconstructions-section" class="accordion-body collapse">
                    <div class="accordion-inner">
                      <table id="reconstructions" class="table table-striped table-bordered table-hover">
                        <thead>
                          <tr>
                            <th>Piece&nbsp;ID</th>
                            <th>Title</th>
                            <th>Author</th>
                            <th>Notes</th>
                            <th>Favourites</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for recon in favourited_reconstructions %}
                            <tr>
                              <td><a href="/piece/{{ recon.piece.piece_id }}">{{ recon.piece.piece_id }}</a></td>
                              <td>{{ recon.piece.title }}</td>
                              <td><a href="/person/{{ recon.reconstructor.person_id }}">{{ recon.reconstructor }}</a></td>
                              <td style="text-align:center;"><button class="btn btn-info">Edit Note</button></td>
                              <td>
                                  {% include "main/favourites/favourites.html" with is_favourite=True piece_id=piece.piece_id %}
                              </td>
                            </tr>
                          {% empty %}
                            <td colspan="5">No reconstructions in Favourites.</td>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>(Currently deemed unnecessary) -->
              </div>

              <div class="tab-pane" id="tab3">
                <!-- My Discussions: Pieces and Reconstructions -->
                <div class="accordion-group">
                  <!-- Discussions about Pieces -->
                  <div class="accordion-heading">
                    <a class="accordion-toggle" data-toggle="collapse" href="#discusspieces-section">
                      <h2>Pieces<i class="icon-minus"></i></h2>
                    </a>
                  </div>
                  <div id="discusspieces-section" class="accordion-body in collapse">
                    <div class="accordion-inner">
                      <table class="table table-striped table-bordered table-hover">
                        <thead>
                          <tr>
                            <th>Piece&nbsp;ID</th>
                            <th>Title</th>
                            <th>Discussion</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for piece in discussed_pieces %}
                            <tr>
                              <td>
                                <a href="/piece/{{ piece.piece_id }}">{{ piece.piece_id }}</a>
                              </td>
                              <td>
                                {{ piece.title }}
                              </td>
                              <td>
                                <a href="/{{ piece.piece_id }}/discussion">View Discussion</a>
                              </td>
                            </tr>
                          {% empty %}
                            <td colspan="3">No pieces discussed.</td>
                          {% endfor %}
                        </tbody>
                      </table> 
                    </div>
                  </div>
                </div>

                <div class="spacerTop">
                </div>

                <div class="accordion-group">
                  <!-- Comments -->
                  <div class="accordion-heading">
                    <a class="accordion-toggle" data-toggle="collapse" href="#discusscomments-section">
                      <h2>Comments<i class="icon-plus"></i></h2>
                    </a>
                  </div>
                  <div id="discusscomments-section" class="accordion-body collapse">
                    <div class="accordion-inner">
                      <table class="table table-striped table-bordered table-hover">
                        <thead>
                          <tr>
                            <th>Piece&nbsp;ID</th>
                            <th>Comment</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for comment in my_comments %}
                            <tr>
                              <td>
                                <a href="/piece/{{ analysis.composition_number.piece_id }}">{{ comment.piece.piece_id }}</a>
                              </td>
                              <td>
                                <a href="/piece/{{ comment.piece.piece_id }}/discussion/">{{ comment.text }}</a>
                              </td>
                            </tr>
                          {% empty %}
                            <td colspan="2">No comments.</td>
                          {% endfor %}
                        </tbody>
                      </table> 
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div><!--/span-->
        </div><!--/row-->
      </div>
    </div>

    <div class="span3"><!-- Everything on the right -->
      <div class="well span12">
        <h3>{{ user.username }}
          <!-- Edit profile functionality not yet added<br />
            <a href="#" id="editpro">Edit&nbsp;Profile</a>
          -->
          &bull; <a href="#" id="logout">Log&nbsp;Out</a>
        </h3>
        <dl class="well-list account-info-list">
          <dt>Joined:</dt>
          <dd>{{ user.date_joined.date }}</dd>
          <dt>Role:</dt>
          <dd>{{ user.profile.role }}</dd>
        </dl>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    // This script expands and hides analysis details
    $('.analyses-info').hide();
    $('.analyses-info-expand').on({
      'click': function(event) {
        event.preventDefault();
        tgt = "#" + $(this).attr('target');
        $(tgt).toggle();
        tag = $(this).text() == "Expand" ? "Collapse" : "Expand";
        $(this).text(tag);
        return false;
      }
    })
  </script>

  <script type="text/javascript">
    // This scripts toggles the plus and minus icons
    (function($) {
      $('document').ready( function() {
        $('.accordion-group').on('show hide', function(e){
          $(e.target).siblings('.accordion-heading').find('.accordion-toggle i').toggleClass('icon-minus icon-plus', 200);
        });
      });
    })(jQuery);
  </script>
{% endblock %}
