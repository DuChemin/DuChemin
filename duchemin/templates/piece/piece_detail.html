{% extends "base.html" %}
{% load is_favourite %}
{% load has_note %}
{% load apostrophe %}

{% block title %}
    <title>Lost Voices &mdash; {{ content.piece_id }}: {{ content.title }}</title>
{% endblock %}

{% block header %}
    <link rel="stylesheet" href="{{ STATIC_URL }}css/dist/meiview.css">
    <link href="//ajax.googleapis.com/ajax/libs/jqueryui/1.8.23/themes/base/jquery-ui.css" rel="stylesheet">
{% endblock %}

{% block wrap %}
    <div class="row-fluid">
        <div class="span12">
            <div class="show-heading row-fluid">
                <div class="span8">
                    <hgroup>
                        <h1>{{ content.title|apostrophe }}</h1>

                        <h2><a href="{{ content.composer_id.url }}">{{ content.composer_id.full_name|apostrophe }}</a></h2>

                        <h3>
                            {{ content.piece_id }}
                            {% if user.is_authenticated %}
                                {% include "main/favourites/favourites.html" with piece_id=content.piece_id %}
                            {% endif %}
                        </h3>
                    </hgroup>

                    <div class="row-fluid">
                        <h2>Text</h2>
                        <table class="table table-striped ">
                            <thead>
                            <tr>
                                <th>Phrase Number</th>
                                <th>Measures</th>
                                <th>Rhyme</th>
                                <th>Phrase</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for phrase in content.phrases %}
                                <tr>
                                    <td>
                                        {{ phrase.phrase_num }}
                                    </td>
                                    <td>
                                        {% if phrase.phrase_start %}
                                            <a href="#" class="view-phrase" data-pieceid="{{ content.piece_id }}"
                                               data-meilink="{{ content.mei_link }}"
                                               data-phrasenum="{{ phrase.phrase_num }}"
                                               data-start="{{ phrase.phrase_start }}"
                                               data-stop="{{ phrase.phrase_stop }}">{{ phrase.phrase_start }}&ndash;{{ phrase.phrase_stop }}</a>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if phrase.rhyme %}
                                            {{ phrase.rhyme }}
                                        {% endif %}
                                    </td>
                                    <td class="line-text">
                                        {{ phrase.phrase_text|apostrophe }}
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="span4">
                    <div class="well span12">
                        <dl class="well-list piece-info-list">
                            <dt>Source:</dt>
                            <dd><a href="{{ content.book_id.url }}">
                                {{ content.book_id.title }}
                            </a>
                            </dd>
                            {% if content.pdf_link or content.mei_link %}
                                <dt>View:</dt>
                                <dd>
                                    {% if content.pdf_link %}
                                        <a href="{{ content.pdf_link }}" target="_blank">Complete Modern Edition
                                            (PDF)</a>
                                    {% endif %}
                                    {% if content.pdf_link and content.mei_link %}
                                        <br/>
                                    {% endif %}
                                    {% if content.mei_link %}
                                        <a href="{{ content.mei_link }}" target="_blank">MEI File</a>
                                    {% endif %}
                                </dd>
                            {% endif %}
                            {% if content.audio_link %}
                                <dt>Listen:</dt>
                                <dd>
                                    <a href="{{ content.audio_link }}" target="_blank">Complete Recording (MP3)</a></dd>
                            {% endif %}
                        </dl>
                    </div>

                    <div id="sidebar" class="span12">
                        {% if user.is_authenticated %}
                            <h3>Notes</h3>
                            <div>
                                {% if user|has_note:content.piece_id %}
                                    <p>You have a note for this piece.</p>
                                    <a href="#" class="btn btn-info">Edit Note</a>
                                    <a href="#" class="btn btn-danger">Delete Note</a>
                                {% else %}
                                    <p>You do not have a note for this piece.</p>
                                    <a href="#" class="btn btn-primary open-EditNote" data-toggle="modal">Add Note</a>
                                {% endif %}
                            </div>
                        {% endif %}

                        <h3>Discussion</h3>
                        <div class="accordion-group">
                            <div class="accordion-heading">
                                <a class="accordion-toggle" id="sidebar-accordion" data-toggle="collapse"
                                   href="#see-comments">
                                    <h3>Recent Comments<i class="icon-plus" id="toggle"></i></h3>
                                </a>
                            </div>
                            <div id="see-comments" class="accordion-body collapse">
                                <div class="accordion-inner">
                                    {% include 'piece/piece_discussion_partial.html' with condensed_view=True %}
                                </div>
                            </div>
                        </div>

                        {% include 'piece/piece_add_comment_partial.html' %}

                        {% if user.is_authenticated %}
                            <h3>Problems</h3>
                            <p>Is this record incorrect? <a
                                    href="mailto:{{ ADMIN_EMAIL }}?subject=Problem with Piece {{ content.piece_id }}">Notify
                                us.</a></p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="row-fluid">
                <h2>Music</h2>
                <!-- Element to contain the viewer. -->
                <div class="viewer" style="margin:0 0 20px;"></div>
            </div>

            <div class="row-fluid">
                <div class="span12 content-container">
                    {% if content.analyses %}
                        <h2>Observations</h2>
                        <table class="table table-striped table-bordered table-hover">
                            <tr>
                                <th>Phrase</th>
                                <th>Measures</th>
                                <th>Analyst</th>
                                <th>Details</th>
                                <th>Nanopublication</th>
                            </tr>

                            {% for analysis in content.analyses %}
                                <tr>
                                    <td>
                                        {{ analysis.phrase_number.phrase_num }}
                                    </td>
                                    <td>
                                        <a href="#" class="view-phrase" data-pieceid="{{ content.piece_id }}"
                                           data-meilink="{{ content.mei_link }}"
                                           data-start="{{ analysis.start_measure }}"
                                           data-stop="{{ analysis.stop_measure }}">{{ analysis.start_measure }}&ndash;{{ analysis.stop_measure }}</a>
                                    </td>
                                    <td>
                                        <a href="{{ analysis.analyst.url }}">{{ analysis.analyst.full_name }}</a>
                                    </td>
                                    <td>
                                        <a href="#" class="analyses-info-expand"
                                           target="analyses-info-{{ forloop.counter }}">Expand</a>
                                    </td>
                                    <td>
                                        <a href="{{ analysis.nanopub_link }}">Nanopub</a>
                                    </td>
                                </tr>
                                <tr id="analyses-info-{{ forloop.counter }}" class="analyses-info">
                                    <td colspan="5">
                                        {% include "analysis/analysis_extended_display_info.html" %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </table>
                        </div>
                    {% else %}
                        {% if user.is_staff %}
                            <a href="{{ content.url }}/add-observation/" class="btn btn-small btn-block">Add
                                Observation</a>
                        {% endif %}
                    {% endif %}
            </div>
        </div>
        <!--/row-->
    </div><!--/span-->

    </div><!--/row-->
{% endblock %}

{% block scripts %}
    <script type="text/javascript" src="{{ STATIC_URL }}js/notes.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/notation.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/favourites.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/comments.js"></script>

    <!-- Can't import all the jquery and bootstrap, since they conflict with each other -->
    <script type="text/javascript" src="{{ STATIC_URL }}js/bootstrap/bootstrap-modal.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/bootstrap/bootstrap-transition.js"></script>

    <script type="text/javascript" src="{{ STATIC_URL }}js/vexflow/vexflow-min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/deps/Fabric-all.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/deps/meitovexflow.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/dist/meiview.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/jquery/src/effects.js"></script>

    <script type="text/javascript">
        // This script expands and hides analysis details
        $('.analyses-info').hide();

        $('.analyses-info-expand').on({
            'click': function (event) {
                event.preventDefault();
                var tgt = "#" + $(this).attr('target');
                $(tgt).toggle();
                var tag = $(this).text() == "Expand" ? "Collapse" : "Expand";

                $(this).text(tag);

                return false;
            }
        });
    </script>

    <script>
        $(document).ready(function () {
            attachPhraseClickEvents();
            attachFavouritesAction();
            attachCommentAction();


            // Toggle +/- on accordions
            $('.accordion-group').on('show hide', function (e) {
                $(e.target).siblings('.accordion-heading').find('.accordion-toggle i').toggleClass('icon-minus icon-plus');
            });
        });
    </script>

    <!-- meiView dependencies and scripts -->
    <script type="application/javascript">
        $(document).ready(function ()
        {
            /* Load an MEI file from an XML document */
            var loadedXML = meiView.Util.loadXMLDoc('{{ content.mei_link }}');

            /* Make sure the file will be suitable for rendering */
            var filteredXml = meiView.filterMei(loadedXML, { noSysBreak: true });

            /* Make sure the MEI will be suitable for rendering */
            var meiDoc = new MeiLib.MeiDoc(filteredXml);

            var pagination = new meiView.Pages({
                length: $(meiDoc.rich_score).find('measure').length,
                mpp: 4
            });

            /* Create a compact viewer. */
            var viewer = new meiView.CompactViewer({
                maindiv: $('.viewer'),
                MEI: meiDoc,
                pages: pagination,
                title: "{{ content.title }}",
                displayFirstPage: true,
                scale: 0.8,
                pxpMeasure: 280
            });
        });
    </script>
{% endblock %}
